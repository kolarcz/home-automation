<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
    <title>Home</title>
  </head>
  <body>
    <svg id="loading" width="100%" height="80" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="84" cy="50" r="0" fill="#ebebeb"><animate attributeName="r" values="10;0;0;0;0" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="0s"/><animate attributeName="cx" values="84;84;84;84;84" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="0s"/></circle><circle cx="84" cy="50" r=".117" fill="#ebebeb"><animate attributeName="r" values="0;10;10;10;0" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="-0.75s"/><animate attributeName="cx" values="16;16;50;84;84" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="-0.75s"/></circle><circle cx="83.603" cy="50" r="10" fill="#ebebeb"><animate attributeName="r" values="0;10;10;10;0" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="-0.375s"/><animate attributeName="cx" values="16;16;50;84;84" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="-0.375s"/></circle><circle cx="49.603" cy="50" r="10" fill="#ebebeb"><animate attributeName="r" values="0;10;10;10;0" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="0s"/><animate attributeName="cx" values="16;16;50;84;84" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="0s"/></circle><circle cx="16" cy="50" r="9.883" fill="#ebebeb"><animate attributeName="r" values="0;0;10;10;10" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="0s"/><animate attributeName="cx" values="16;16;16;50;84" keyTimes="0;0.25;0.5;0.75;1" keySplines="0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1;0 0.5 0.5 1" calcMode="spline" dur="1.5s" repeatCount="indefinite" begin="0s"/></circle></svg>
    <canvas id="chart" style="display: none"></canvas>
    <script>
      /**
       * Configs
       */

      const projectId = 'xxxxxxxxx';
      const apiKey = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
      const credentials = ['xxxxxxx@gmail.com', 'xxxxxxx'];
      const collection = 'weatherByHour';
      const limit = 7 * 24;


      /**
       * Functions
       */

      function getDataFromFirebaseDb(collection, limit, callback) {
        firebase.database()
          .ref(collection)
          .orderByChild('date')
          .limitToLast(limit)
          .on('value', (snapshot) => {
            const data = Object.values(snapshot.val())
              .map((record) => ({
                ...record,
                date: new Date(record.date)
              }));

            callback(data);
          });
      }


      /**
       * Chart
       */

      const ctx = document.getElementById('chart').getContext('2d');

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Temperature',
            backgroundColor: '#ff8888',
            borderColor: 'red',
            yAxisID: 'id-temperature',
            fill: false,
            unit: '°C'
          }, {
            label: 'Humidity',
            backgroundColor: '#8888ff',
            borderColor: 'blue',
            yAxisID: 'id-humidity',
            fill: false,
            unit: '%'
          }, {
            label: 'Temperature outside',
            backgroundColor: '#ffe9e9',
            borderColor: '#ffd9d9',
            yAxisID: 'id-temperature',
            fill: false,
            unit: '°C'
          }, {
            label: 'Humidity outside',
            backgroundColor: '#e9e9ff',
            borderColor: '#d9d9ff',
            yAxisID: 'id-humidity',
            fill: false,
            unit: '%'
          }]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Home'
          },
          tooltips: {
            mode: 'nearest',
            position: 'nearest',
            intersect: true,
            callbacks: {
              title: TooltipItems => `${moment(new Date(TooltipItems[0].label)).format('D. M. H:mm')} (øh)`,
              label: (TooltipItem, obj) => {
                const dataset = obj.datasets[TooltipItem.datasetIndex];
                return `${dataset.label}: ${TooltipItem.yLabel.toLocaleString()} ${dataset.unit}`
              }
            }
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Time'
              },
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'H:mm'
                }
              },
              ticks: {
                padding: 10
              }
            }],
            yAxes: [{
              type: 'linear',
              scaleLabel: {
                display: true,
                labelString: 'Temperature'
              },
              position: 'left',
              id: 'id-temperature',
              ticks: {
                callback: tick => `${tick.toLocaleString()} °C`,
                padding: 10
              }
            }, {
              type: 'linear',
              scaleLabel: {
                display: true,
                labelString: 'Humidity'
              },
              position: 'right',
              id: 'id-humidity',
              gridLines: {
                drawOnChartArea: false
              },
              ticks: {
                callback: tick => `${tick.toLocaleString()} %`,
                padding: 10
              }
            }]
          }
        }
      });


      /**
       * Firebase
       */

      firebase.initializeApp({
         apiKey,
         projectId,
         databaseURL: `https://${projectId}.firebaseio.com`
      });

      firebase.auth().signInWithEmailAndPassword(...credentials).then(() => {
        getDataFromFirebaseDb(collection, limit, (data) => {
          const dataTemperature = [];
          const dataHumidity = [];
          const dataTemperatureOutside = [];
          const dataHumidityOutside = [];

          data.forEach((record) => {
            const { date, temperature, humidity, temperatureOutside, humidityOutside } = record;

            dataTemperature.push({
              x: date,
              y: temperature
            });
            dataHumidity.push({
              x: date,
              y: humidity
            });
            dataTemperatureOutside.push({
              x: date,
              y: temperatureOutside
            });
            dataHumidityOutside.push({
              x: date,
              y: humidityOutside
            });
          });

          chart.data.datasets[0].data = dataTemperature;
          chart.data.datasets[1].data = dataHumidity;
          chart.data.datasets[2].data = dataTemperatureOutside;
          chart.data.datasets[3].data = dataHumidityOutside;

          document.getElementById('loading').style.display = 'none';
          chart.canvas.style.display = 'block';

          chart.update();
        });
      });
    </script>
  </body>
</html>
