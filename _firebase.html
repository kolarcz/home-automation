<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <script src="https://www.gstatic.com/firebasejs/5.9.1/firebase.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.13.0/moment.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@2.8.0"></script>
  </head>
  <body>
    <canvas id="chart"></canvas>
    <script>
      /**
       * Configs
       */

      const projectId = 'xxxxxxxxx';
      const apiKey = 'xxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
      const credentials = ['xxxxxxx@gmail.com', 'xxxxxxx'];
      const collection = 'weather'; // || weatherByDay
      const limit = 12 * 24 * 10; // 10 days
      const groupedByHours = true;


      /**
       * Functions
       */

      function groupByHours(data) {
        const tmp = {};

        data.forEach(({ x, y }) => {
          const key = `${x.getFullYear()}-${x.getMonth()}-${x.getDate()}-${x.getHours()}`;
          if (!tmp[key]) tmp[key] = [];
          tmp[key].push(y);
        });

        const newData = Object.entries(tmp).map(([dateKey, values]) => {
          const [ year, month, day, hour ] = dateKey.split('-');
          const date = new Date(year, month, day, hour);
          const average = Math.round(values.reduce((a, b) => a + b) / values.length * 100) / 100;

          return {
            x: date,
            y: average
          };
        });

        return newData;
      }

      function getDataFromFirebaseFs(collection, limit, callback) {
        firebase.firestore()
          .collection(collection)
          .orderBy('date', 'desc')
          .limit(limit)
          .onSnapshot((snapshot) => {
            const data = snapshot.docs
              .map(d => d.data())
              .map((record) => ({
                ...record,
                date: record.date.toDate()
              }));

            callback(data);
          });
      }

      function getDataFromFirebaseDb(collection, limit, callback) {
        firebase.database()
          .ref(collection)
          .orderByChild('date')
          .limitToLast(limit)
          .on('value', (snapshot) => {
            const data = Object.values(snapshot.val())
              .map((record) => ({
                ...record,
                date: new Date(record.date)
              }));

            callback(data);
          });
      }


      /**
       * Chart
       */

      const ctx = document.getElementById('chart').getContext('2d');

      const chart = new Chart(ctx, {
        type: 'line',
        data: {
          datasets: [{
            label: 'Teplota',
            backgroundColor: '#ff8888',
            borderColor: 'red',
            yAxisID: 'id-temperature',
            fill: false,
            unit: '°C'
          }, {
            label: 'Vlhkost',
            backgroundColor: '#8888ff',
            borderColor: 'blue',
            yAxisID: 'id-humidity',
            fill: false,
            unit: '%'
          }, {
            label: 'Teplota venku',
            backgroundColor: '#ffe9e9',
            borderColor: '#ffd9d9',
            yAxisID: 'id-temperature',
            fill: false,
            unit: '°C'
          }, {
            label: 'Vlhkost venku',
            backgroundColor: '#e9e9ff',
            borderColor: '#d9d9ff',
            yAxisID: 'id-humidity',
            fill: false,
            unit: '%'
          }]
        },
        options: {
          responsive: true,
          title: {
            display: true,
            text: 'Doma'
          },
          tooltips: {
            mode: 'nearest', // index
            position: 'nearest', // average
            intersect: true,
            callbacks: {
              title: TooltipItems => moment(new Date(TooltipItems[0].label)).format('D. M. H:mm'),
              label: (TooltipItem, obj) => {console.log(TooltipItem)
                const dataset = obj.datasets[TooltipItem.datasetIndex];
                return `${dataset.label}: ${TooltipItem.yLabel.toLocaleString()} ${dataset.unit}`
              }
            }
          },
          scales: {
            xAxes: [{
              type: 'time',
              scaleLabel: {
                display: true,
                labelString: 'Čas'
              },
              time: {
                unit: 'hour',
                displayFormats: {
                  hour: 'H:mm'
                }
              }
            }],
            yAxes: [{
              type: 'linear',
              scaleLabel: {
                display: true,
                labelString: 'Teplota'
              },
              position: 'left',
              id: 'id-temperature',
              ticks: {
                userCallback: tick => `${tick.toLocaleString()} °C`
              }
            }, {
              type: 'linear',
              scaleLabel: {
                display: true,
                labelString: 'Vlhkost'
              },
              position: 'right',
              id: 'id-humidity',
              gridLines: {
                drawOnChartArea: false
              },
              ticks: {
                userCallback: tick => `${tick.toLocaleString()} %`
              }
            }]
          }
        }
      });


      /**
       * Firebase
       */

      firebase.initializeApp({
         apiKey,
         projectId,
         databaseURL: `https://${projectId}.firebaseio.com`
      });

      firebase.auth().signInWithEmailAndPassword(...credentials).then(() => {
        getDataFromFirebaseDb(collection, limit, (data) => {
          const dataTemperature = [];
          const dataHumidity = [];
          const dataTemperatureOutside = [];
          const dataHumidityOutside = [];

          data.forEach((record) => {
            const { date, temperature, humidity, temperatureOutside, humidityOutside } = record;

            dataTemperature.push({
              x: date,
              y: temperature
            });
            dataHumidity.push({
              x: date,
              y: humidity
            });
            dataTemperatureOutside.push({
              x: date,
              y: temperatureOutside
            });
            dataHumidityOutside.push({
              x: date,
              y: humidityOutside
            });
          });

          chart.data.datasets[0].data = groupedByHours ? groupByHours(dataTemperature) : dataTemperature;
          chart.data.datasets[1].data = groupedByHours ? groupByHours(dataHumidity) : dataHumidity;
          chart.data.datasets[2].data = groupedByHours ? groupByHours(dataTemperatureOutside) : dataTemperatureOutside;
          chart.data.datasets[3].data = groupedByHours ? groupByHours(dataHumidityOutside) : dataHumidityOutside;

          chart.update();
        });
      });
    </script>
  </body>
</html>
